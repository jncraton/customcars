<!DOCTYPE html>
<html lang=en>
<head>
<meta charset=utf-8 /> 
<meta name=viewport content="width=device-width, initial-scale=1"/>
<title>Custom Cars</title>
<style>
* {
  margin:0;
  padding:0;
}
html,body {
  width:90vw;
  height:45vw;
  margin: 0 auto;
}
canvas {
  width:100%;
  height:100%;
  image-rendering: crisp-edges;
}
</style>
</head>
<body>
<canvas width=360 height=180></canvas>

<script>
const canvas = document.querySelector('canvas')
const ctx = canvas.getContext('2d')
ctx.imageSmoothingEnabled = false

let color = 0
let scale = 1

const pixel_size = 18
const im_width = 17
const im_height = 7


let colors = []
// Grays
for (i = 100; i >=0; i-=25) {
  colors.push('hsl(0,0%,' + i + '%)')
}

// Rainbow
for (i = 0; i < 360; i+=15) {
  colors.push('hsl(' + i + ',80%,60%)')
}

const chars = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_?/:@.~!$&'()*+,="

if (location.hash.length < 50) {
  location.hash = '#' + Array(im_width*im_height).join(0)
}

function redraw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  colors.forEach((color, i) => {
    ctx.fillStyle = color
    ctx.strokeStyle = 'hsl(0,0%,20%)'
    ctx.lineWidth = 1
    if (i <= 8) {
      ctx.fillRect(
        0,
        0 + i * pixel_size,
        pixel_size,
        pixel_size,
      )
      ctx.strokeRect(
        .5,
        .5 + i * pixel_size,
        pixel_size,
        pixel_size,
      )
    } else {
      ctx.fillRect(
        (i - 9) * pixel_size,
        canvas.height - pixel_size,
        pixel_size,
        pixel_size,
      )
      ctx.strokeRect(
        .5 + (i - 9) * pixel_size,
        .5 + canvas.height - pixel_size,
        pixel_size,
        pixel_size - 1,
      )
    }
  })
  ctx.strokeRect(
    canvas.width - pixel_size + .5,
    canvas.height - pixel_size + .5,
    pixel_size - 1,
    pixel_size - 1,
  )

  let getPixel = (x,y) => {
    x = Math.min(Math.max(0,x), im_width - 1)
    y = Math.min(Math.max(0,y), im_height - 1)
    return chars.indexOf(location.hash[1 + im_width*y + x])
  }

  for (x=0; x<im_width; x++) {
    for (y=0; y<im_height; y++) {
      if (scale == 2) {
        // Scale2x algorith
        // https://en.wikipedia.org/wiki/Pixel-art_scaling_algorithms
        let p = getPixel(x, y)
        let a = getPixel(x, y-1)
        let b = getPixel(x+1, y)
        let c = getPixel(x-1, y)
        let d = getPixel(x, y+1)

        ctx.fillStyle = colors[p]
        if (c==a && c!=d && a!=b) ctx.fillStyle = colors[a]
        ctx.fillRect(
          (x+2) * pixel_size,
          (y+1) * pixel_size,
          pixel_size / 2,
          pixel_size / 2,
        )    

        ctx.fillStyle = colors[p]
        if (a==b && a!=c && b!=d) ctx.fillStyle = colors[b]
        ctx.fillRect(
          (x+2) * pixel_size + pixel_size / 2,
          (y+1) * pixel_size,
          pixel_size / 2,
          pixel_size / 2,
        )    

        ctx.fillStyle = colors[p]
        if (d==c && d!=b && c!=a) ctx.fillStyle = colors[c]
        ctx.fillRect(
          (x+2) * pixel_size,
          (y+1) * pixel_size + pixel_size / 2,
          pixel_size / 2,
          pixel_size / 2,
        )    

        ctx.fillStyle = colors[p]
        if (b==d && b!=a && d!=c) ctx.fillStyle = colors[d]
        ctx.fillRect(
          (x+2) * pixel_size + pixel_size / 2,
          (y+1) * pixel_size + pixel_size / 2,
          pixel_size / 2,
          pixel_size / 2,
        )
      } else {
        ctx.fillStyle = colors[getPixel(x,y)]
        ctx.fillRect(
          (x+2) * pixel_size,
          (y+1) * pixel_size,
          pixel_size,
          pixel_size,
        )
      }
    }
  }
}
redraw()

canvas.addEventListener('click', e => {
  let x = (e.clientX - canvas.getBoundingClientRect().x) * canvas.width / canvas.clientWidth
  x = Math.floor(x / pixel_size)
  let y = (e.clientY - canvas.getBoundingClientRect().y) * canvas.height / canvas.clientHeight
  y = Math.floor(y / pixel_size)
  if (x == 0) {
    color = y
  } else if (y == 9) {
    color = x + 9
  } else {
    x -= 2
    y -= 1
    if (x >= 0 && x < im_width && y >= 0 && y < im_height) {
      let pixels = location.hash.split('')
      pixels[1 + im_width*y + x] = chars[color]
      location.hash = pixels.join('')
      redraw()
    }
  }
})

document.addEventListener('keydown', e => {
  if (e.key == 1) scale = 1
  if (e.key == 2) scale = 2
  redraw()
})
</script>

</body>
</html>